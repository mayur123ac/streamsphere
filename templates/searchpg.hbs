<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamSphere - Search & Analytics</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/homepage.css" />
    <link rel="stylesheet" href="/css/upload.css" />
    <link rel="stylesheet" href="/css/series.css">
</head>

<body>
    <div id="page-loader">
        <div class="loader-spinner"></div>
    </div>
    <div class="navbar" id="header">
        <div class="logo hidden1">
            <img src="/assets/hand1.png" alt="Streamsphere.png" />
        </div>

        <div class="menu-toggle" id="menu-toggle"><span></span><span></span><span></span></div>

        <ul class="hidden1 nav-links">
            <a href="/homepage">
                <li>Movies</li>
            </a>
            <a href="/searchpg">
                <li>Search</li>
            </a>
            <a href="/mylist">
                <li>My List</li>
            </a>

            {{#if isAdmin}}
            <li class="admin-trigger" onclick="toggleModal('movieModal')">Add Movie</li>
            <li class="admin-trigger" onclick="openAnalytics()">Analytics</li>
            {{/if}}

            <a href="/series">
                <li>TV Shows</li>
            </a>
        </ul>

        <div class="profile-container">
            <div class="profile-icon">
                <img src="https://net51.cc/pv/assets/prime-user.png" alt="Profile">
                <span class="caret">▼</span>
            </div>
            <div class="profile-dropdown hidden2">
                <div class="profile-header">
                    <img src="https://net51.cc/pv/assets/prime-user.png" alt="Avatar">
                    <div class="profile-text">
                        <span class="profile-name">{{name}}</span>
                        <span class="profile-email">{{email}}</span>
                    </div>
                </div>
                <hr>
                <a href="/account" class="dropdown-item">Account</a>
                <a href="/contactus" class="dropdown-item">SphereBot</a>
                <hr>
                <a href="/logout" class="dropdown-item sign-out">Sign out</a>
            </div>
        </div>
    </div>

    <div class="search-wrapper">
        <div class="search-input-container">
            <input type="text" id="searchInput" placeholder="Search titles, genres..." onkeyup="filterMovies()">
        </div>
    </div>
    <h1 style="text-align: center;font-size: 1rem">We are continuously working to add more movies and series...</h1>

    <div class="panel-overlay" id="movieModal">
        <div class="admin-panel">
            <span class="close-panel" onclick="toggleModal('movieModal')">&times;</span>
            <h2>Add Movie</h2>
            <div class="form-group"><label>Title & Year</label><input type="text" id="adminTitle"></div>
            <div class="form-group"><label>Genre</label><input type="text" id="adminGenre"></div>
            <div class="form-group"><label>Image URL</label><input type="text" id="adminImg"></div>
            <div class="form-group"><label>Stream Link</label><input type="text" id="adminLink"></div>
            <div class="form-group"><label>Description</label><textarea id="adminDesc" rows="3"></textarea></div>
            <button class="upload-btn" onclick="addMovie()">+ Upload Movie</button>
        </div>
    </div>

    <div id="seriesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSeriesModal()">&times;</span>
            <div class="modal-hero">
                <img id="modal-hero-img" src="" alt="Series Banner">
                <div class="modal-hero-text">
                    <h1 id="modal-title"></h1>
                    <div class="modal-meta">
                        <span class="match">98% Match</span>
                        <span id="modal-year"></span>
                        <span class="age">18+</span>
                        <span id="modal-seasons"></span>
                    </div>
                    <p id="modal-desc"></p>
                </div>
            </div>
            <div class="modal-episodes-container">
                <div class="episodes-header">
                    <h3>Episodes</h3>
                    <select id="season-select" class="season-select"></select>
                </div>
                <div class="episodes-list" id="episodes-list"></div>
            </div>
        </div>
    </div>

    <div class="results-container" id="resultsContainer"></div>

    <script src="/js/movieData.js"></script> 
    <script src="/js/episodes.js"></script> 

    <script>
        const currentUserEmail = "{{email}}";
        const ADMIN_EMAIL = "mayurac123@admin.com";
        const API_URL = "/api/movies"; 
        let allContent = [];

        // --- 1. DATA MERGING ---
        function transformSeriesData() {
            if (typeof SERIES_DATA === 'undefined') return [];
            return Object.keys(SERIES_DATA).map(key => {
                if (key === 'default') return null;
                const s = SERIES_DATA[key];
                return { title: s.title, genre: "TV Series", description: s.desc, image: s.image, type: 'series', dataId: key };
            }).filter(i => i);
        }

        async function loadContent() {
            try {
                // Fetch DB Movies
                const response = await fetch(API_URL);
                const dbMovies = await response.json();
                // Get Static Movies from movieData.js
                const staticMovies = (typeof STATIC_MOVIES !== 'undefined') ? STATIC_MOVIES : [];
                // Merge everything
                allContent = [...dbMovies, ...transformSeriesData(), ...staticMovies];
            } catch (err) {
                console.error(err);
                // Fallback if DB fails
                allContent = [...transformSeriesData(), ...STATIC_MOVIES];
            }
            renderContent(allContent);
        }

        function renderContent(data) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = data.length ? "" : "<p style='color:#777;'>No results found.</p>";

            data.forEach(item => {
                let actionBtn = item.type === 'series'
                    ? `<button class="play-btn" onclick="openSeriesModal('${item.dataId}')">ℹ Episodes</button>`
                    : `<a href="${item.link}"><button class="play-btn">▶ Play</button></a>`;

                let deleteBtn = (currentUserEmail === ADMIN_EMAIL && item._id) 
                    ? `<button class="delete-btn" onclick="deleteMovie('${item._id}')">✖</button>` : "";

                container.insertAdjacentHTML('beforeend', `
                <div class="carde">
                    ${deleteBtn}
                    <img src="${item.image}" alt="${item.title}" onerror="this.src='https://via.placeholder.com/200x300'">
                    <div class="info-right">
                        <h3>${item.title}</h3>
                        <p class="genre">${item.genre}</p>
                        <p class="description">${item.description || ''}</p>
                        <div class="btn-group">${actionBtn}<button class="add-btn" onclick="addToMyList(this)">+</button></div>
                    </div>
                </div>`);
            });
            attachCardEvents();
        }

        // --- FIXED CARD EVENTS (Auto-Close Logic) ---
        function attachCardEvents() {
            const cards = document.querySelectorAll(".carde");
            
            cards.forEach(card => {
                card.addEventListener("click", (e) => {
                    // Ignore clicks on buttons/links/mobile
                    if (window.innerWidth <= 768 || e.target.closest("button") || e.target.closest("a") || e.target.classList.contains('delete-btn')) return;
                    
                    // Check if the clicked card is currently open
                    const isAlreadyOpen = card.classList.contains("active");

                    // 1. Close ALL currently open cards (Reset width is crucial!)
                    document.querySelectorAll(".carde.active").forEach(c => {
                        c.classList.remove("active");
                        c.style.width = ""; // Reset inline width style
                    });

                    // 2. If it wasn't open before, open it now
                    if (!isAlreadyOpen) {
                        card.classList.add("active");
                        card.style.width = "420px";
                    }
                });
            });
        }

        function filterMovies() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            renderContent(allContent.filter(m => m.title.toLowerCase().includes(q) || m.genre.toLowerCase().includes(q)));
        }

        // Admin Functions
        async function addMovie() {
            const title = document.getElementById('adminTitle').value;
            const img = document.getElementById('adminImg').value;
            if(!title || !img) return alert("Missing info");
            
            await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, 
                body: JSON.stringify({
                    title, 
                    genre:document.getElementById('adminGenre').value, 
                    image:img, 
                    link:document.getElementById('adminLink').value, 
                    description:document.getElementById('adminDesc').value
                }) 
            });
            loadContent(); toggleModal('movieModal');
        }

        async function deleteMovie(id) {
            if(confirm("Delete?")) { await fetch(`${API_URL}/${id}`, {method:'DELETE'}); loadContent(); }
        }

        // UI Helpers
        function toggleModal(id) { document.getElementById(id)?.classList.toggle('active'); }
        function closeSeriesModal() { 
            const modal = document.getElementById('seriesModal');
            if(modal) { modal.style.display = "none"; document.body.style.overflow = "auto"; }
        }
        function openAnalytics() { window.location.href = "/analysis"; }
        function addToMyList(btn) { btn.innerText = "✓"; btn.style.color = "#2ed573"; btn.style.borderColor = "#2ed573"; }

        // Profile Dropdown
        document.querySelector('.profile-container').addEventListener('click', (e) => {
            e.stopPropagation(); document.querySelector('.profile-container').classList.toggle('active');
        });
        document.addEventListener('click', () => document.querySelector('.profile-container').classList.remove('active'));

        // Initialize
        loadContent();
    </script>
    
    <script src="/js/css.js"></script>
    <script src="/js/mobilescript.js"></script>
    <script src="/js/pageloader.js"></script>
</body>
</html>