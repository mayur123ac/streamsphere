<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamSphere - Search & Analytics</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/homepage.css" />
    <link rel="stylesheet" href="/css/upload.css" />

</head>

<body>
    <div id="page-loader">
        <div class="loader-spinner"></div>
    </div>
    <div class="navbar" id="header">
        <div class="logo hidden1">
            <img src="/assets/hand1.png" alt="Streamsphere.png" />
        </div>

        <div class="menu-toggle" id="menu-toggle"><span></span><span></span><span></span></div>

        <ul class="hidden1 nav-links">
            <a href="/homepage">
                <li>Movies</li>
            </a>
            <a href="/searchpg">
                <li>Search</li>
            </a>
            <a href="/mylist">
                <li>My List</li>
            </a>

            {{#if isAdmin}}
            <li class="admin-trigger" onclick="toggleModal('movieModal')">Add Movie</li>
            <li class="admin-trigger" onclick="openAnalytics()">Analytics</li>
            {{/if}}

            <a href="/series">
                <li>TV Shows</li>
            </a>
        </ul>

        <div class="profile-container">
            <div class="profile-icon">
                <img src="https://net51.cc/pv/assets/prime-user.png" alt="Profile">
                <span class="caret">▼</span>
            </div>
            <div class="profile-dropdown hidden2">
                <div class="profile-header">
                    <img src="https://net51.cc/pv/assets/prime-user.png" alt="Avatar">
                    <div class="profile-text">
                        <span class="profile-name">{{name}}</span>
                        <span class="profile-email">{{email}}</span>
                    </div>
                </div>
                <hr>
                <a href="/account" class="dropdown-item">Account</a>
                <a href="/contactus" class="dropdown-item">SphereBot</a>
                <hr>
                <a href="/logout" class="dropdown-item sign-out">Sign out</a>
            </div>
        </div>
    </div>

    <div class="search-wrapper">
        <div class="search-input-container">
            <input type="text" id="searchInput" placeholder="Search titles, genres..." onkeyup="filterMovies()">
        </div>
    </div>
    <h1 style="text-align: center;font-size: 1rem">We are continuosly working to add more movies and series...</h1>
    <div class="panel-overlay" id="movieModal">
        <div class="admin-panel">
            <span class="close-panel" onclick="toggleModal('movieModal')">&times;</span>
            <h2>Add Movie</h2>
            <div class="form-group"><label>Title & Year</label><input type="text" id="adminTitle"></div>
            <div class="form-group"><label>Genre</label><input type="text" id="adminGenre"></div>
            <div class="form-group"><label>Image URL</label><input type="text" id="adminImg"></div>
            <div class="form-group"><label>Stream Link</label><input type="text" id="adminLink"></div>
            <div class="form-group"><label>Description</label><textarea id="adminDesc" rows="3"></textarea></div>
            <button class="upload-btn" onclick="addMovie()">+ Upload Movie</button>
        </div>
    </div>

    <div class="results-container" id="resultsContainer"></div>

    <script>
        const currentUserEmail = "{{email}}";
        const ADMIN_EMAIL = "mayurac123@admin.com";

        // Redirect logic for Analytics
        function openAnalytics() {
            window.location.href = "/analysis";
        }

        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.toggle('active');
        }

        const defaultMovies = [
            { title: "Demon Slayer: Infinity Castle", genre: "Anime • Action", description: "The Demon Slayer Corps plunges into the shifting Infinity Castle.", image: "https://m.media-amazon.com/images/M/MV5BOGQ3YWUzYjEtMTJiYy00ZjQ0LWI0YjktYjhiNGVhNGExYTM3XkEyXkFqcGc@._V1_.jpg", link: "/demonslayer" },
            { title: "A Minecraft Movie", genre: "Adventure • Fantasy", description: "Four misfits are pulled through a mysterious portal into the Overworld.", image: "https://upload.wikimedia.org/wikipedia/en/6/66/A_Minecraft_Movie_poster.jpg", link: "https://vidlink.pro/movie/950387" },
            { title: "F1 (2025)", genre: "Action • Sports", description: "A former Formula One driver returns to the grid to mentor a young prodigy.", image: "https://upload.wikimedia.org/wikipedia/en/3/38/F1_%282025_film%29.png", link: "/f1movie" },
            { title: "Oppenheimer", genre: "Biography • Drama", description: "The story of American scientist J. Robert Oppenheimer.", image: "https://m.media-amazon.com/images/M/MV5BN2JkMDc5MGQtZjg3YS00NmFiLWIyZmQtZTJmNTM5MjVmYTQ4XkEyXkFqcGc@._V1_FMjpg_UX1000_.jpg", link: "https://player.videasy.net/movie/872585" }
        ];

        let movies = [];

        function loadMovies() {
            const stored = localStorage.getItem('streamSphereDB');
            movies = stored ? JSON.parse(stored) : defaultMovies;
            if (!stored) localStorage.setItem('streamSphereDB', JSON.stringify(movies));
            renderMovies(movies);
        }

        function renderMovies(data) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = "<p style='color:#777; margin-top:20px;'>No movies found.</p>";
                return;
            }

            data.forEach((movie, index) => {
                let deleteButtonHTML = "";
                // JS check for dynamic elements (Delete Button)
                if (currentUserEmail === ADMIN_EMAIL) {
                    deleteButtonHTML = `<button class="delete-btn" onclick="deleteMovie(${index})">✖</button>`;
                }

                const card = `
                <div class="carde">
                    ${deleteButtonHTML}
                    <img src="${movie.image}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/200x300'">
                    <div class="info-right">
                        <h3>${movie.title}</h3>
                        <p class="genre">${movie.genre}</p>
                        <p class="description">${movie.description}</p>
                        <div class="btn-group">
                            <a href="${movie.link}">
                                <button class="play-btn">▶ Play</button>
                            </a>
                            <button class="add-btn" onclick="addToMyList(this)">+</button>
                        </div>
                    </div>
                </div>
                `;
                container.innerHTML += card;
            });

            attachCardEvents();
        }

        function attachCardEvents() {
            const container = document.getElementById('resultsContainer');
            const cards = container.querySelectorAll(".carde");

            cards.forEach((card) => {
                card.addEventListener("click", (e) => {
                    // STOP expansion logic on mobile since info is already visible
                    if (window.innerWidth <= 768) return;

                    if (e.target.closest("button") || e.target.closest("a") || e.target.classList.contains('delete-btn')) { return; }

                    const openCards = container.querySelectorAll(".carde.active");
                    openCards.forEach((c) => { if (c !== card) { c.classList.remove("active"); c.style.width = ""; } });

                    const isOpen = card.classList.contains("active");
                    if (!isOpen) {
                        card.classList.add("active");
                        card.style.width = "420px";
                    } else {
                        card.classList.remove("active");
                        card.style.width = "";
                    }
                });
            });
        }

        function addMovie() {
            const title = document.getElementById('adminTitle').value;
            const genre = document.getElementById('adminGenre').value;
            const img = document.getElementById('adminImg').value;
            const link = document.getElementById('adminLink').value;
            const desc = document.getElementById('adminDesc').value;

            if (!title || !img) { alert("Title and Image required"); return; }

            movies.unshift({ title, genre, image: img, link, description: desc });
            localStorage.setItem('streamSphereDB', JSON.stringify(movies));
            renderMovies(movies);
            toggleModal('movieModal');

            document.getElementById('adminTitle').value = "";
            document.getElementById('adminImg').value = "";
            document.getElementById('adminLink').value = "";
            document.getElementById('adminDesc').value = "";
        }

        function deleteMovie(index) {
            if (confirm("Delete this movie?")) {
                movies.splice(index, 1);
                localStorage.setItem('streamSphereDB', JSON.stringify(movies));
                renderMovies(movies);
            }
        }

        function filterMovies() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = movies.filter(m => m.title.toLowerCase().includes(q) || m.genre.toLowerCase().includes(q));
            renderMovies(filtered);
        }

        function addToMyList(btn) {
            btn.innerText = btn.innerText === "+" ? "✓" : "+";
            btn.style.borderColor = btn.innerText === "✓" ? "#2ed573" : "#777";
            btn.style.color = btn.innerText === "✓" ? "#2ed573" : "#777";
        }

        const profile = document.querySelector('.profile-container');
        profile.addEventListener('click', (e) => {
            e.stopPropagation();
            profile.classList.toggle('active');
        });
        document.addEventListener('click', () => profile.classList.remove('active'));

        loadMovies();
    </script>


    <script src="/js/css.js"></script>
    <script src="/js/mobilescript.js"></script>
    <script src="/js/pageloader.js"></script>

</body>

</html>